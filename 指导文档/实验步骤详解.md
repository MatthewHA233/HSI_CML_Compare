# 实验步骤详解

## 一、研究流程总览

| 步骤 | 内容 | 输出成果 |
|------|------|----------|
| ① | 选定样本与时间 | 股票清单 |
| ② | 收集与清洗数据 | 价格与收益率表 |
| ③ | 计算均值-方差 | μ 与 Σ 矩阵 |
| ④ | 构建有效前沿 | 风险-收益曲线 |
| ⑤ | 加入无风险资产 | 资本市场线 + M点 |
| ⑥ | 比较恒生指数与M | HSI与M对比图 |
| ⑦ | 解释结果并写论文 | 结论与启示章节 |

---

## 第1步：选定样本与时间区间

### 目标
明确分析范围和样本股票。

### 建议选择

| 项目 | 建议选择 |
|------|----------|
| 市场 | 香港交易所 (HKEX) |
| 指数 | 恒生指数 (^HSI) |
| 股票样本 | 恒指成分股 30~50 只 (代表性强、流动性高) |
| 时间区间 | 2019-01-01 至 2024-12-31 (五年日度数据) |
| 数据频率 | 日收益率 (daily returns) |

### 输出成果
样本公司清单 + 时间范围定义（Excel表格或Python列表都可）

---

## 第2步：收集与清洗数据

### 目标
获取干净的股票价格数据（最好是"调整后收盘价"Adjusted Close）。

### 推荐渠道

- **Yahoo Finance** (`yfinance` 库)
- 或 **Stooq.com** (可直接下载CSV文件)

### Python示例代码

```python
import yfinance as yf

tickers = ['0700.HK', '9988.HK', '2318.HK', '0941.HK', '0011.HK', '0005.HK']
data = yf.download(tickers, start='2019-01-01', end='2024-12-31')['Adj Close']
data.to_csv('hk_stocks.csv')
```

### 数据清洗步骤

#### 2.1 合并多个文件（如有分段数据）
- 合并两个文件：2019-2022, 2023-2025

#### 2.2 保留字段
- 日期、股票代码、收盘价

#### 2.3 删除退市公司
- 用"退市信息"核对

#### 2.4 确保所有股票日期对齐
- 同一天都有在收盘价

### 处理步骤

1. **去除缺失日期**：删除缺失数据过多的股票或日期
2. **计算每日对数收益率**：

$$r_t = \ln\frac{P_t}{P_{t-1}}$$

3. **去除极端值** (winsorize 1%~99%)：防止异常值影响

### 输出成果

- `returns.csv` (股票每日收益率矩阵)
- `summary_stats.csv` (均值、标准差、协方差)

---

## 第3步：计算投资组合的均值-方差特征

### 目标
为每只股票计算期望收益与风险，并求出协方差矩阵。

### 主要计算

$$\mu_i = E(r_i), \quad \sigma_i^2 = Var(r_i)$$

$$\Sigma = Cov(r_i, r_j)$$

### Python示例

```python
import pandas as pd

returns = pd.read_csv('returns.csv', index_col=0)
mu = returns.mean() * 252          # 年化收益率
Sigma = returns.cov() * 252        # 年化协方差矩阵
```

### 输出结果

- 平均收益率向量 **μ**
- 协方差矩阵 **Σ**

---

## 第4步：构建有效前沿 (Efficient Frontier)

### 目标
在给定 μ 和 Σ 的基础上，求解最优权重组合。

### 数学模型

使用优化（最小化方差、给定收益）：

$$\min_w \sigma_p^2 = w'\Sigma w \quad s.t. \sum w_i = 1, \quad E(R_p) = w'\mu$$

扫描不同 $\mu_p$，得到曲线。

### 工具选择

- **Python**: `cvxpy` 或 `scipy.optimize`
- **Excel**: Solver 求最小方差

### Python简例

```python
import numpy as np
import cvxpy as cp

n = len(mu)
w = cp.Variable(n)
ret = mu.values @ w
risk = cp.quad_form(w, Sigma.values)
prob = cp.Problem(cp.Minimize(risk), [cp.sum(w) == 1])
prob.solve()
```

### 绘图

- 横轴：风险 (σ_p)
- 纵轴：收益 (E[R_p])

### 输出

- 有效前沿曲线
- 不同组合的风险-收益坐标点

---

## 第5步：加入无风险资产，绘制资本市场线 (CML)

### 目标
计算切点组合 M（即风险资产与无风险资产的最优混合点）。

### 步骤

#### 5.1 设定无风险利率 $R_f$
从 **HKMA 3个月期国债收益率** 获取（约 2~3%）

#### 5.2 计算夏普比率最大化组合

$$\max_w \frac{E(R_p) - R_f}{\sigma_p}$$

最大化夏普比率，得到切点组合 $M$。

#### 5.3 绘制CML线
从 $R_f$ 经过 $M$。

### 输出成果

- 资本市场线 (CML) 图
- 市场组合 M 的坐标 (E[Rm], σ_m)
- 夏普比率 $S_m$

---

## 第6步：计算恒生指数 (HSI) 的收益与风险

### 目标
检验恒生指数是否位于有效前沿或CML上。

### 步骤

#### 6.1 下载恒生指数数据
从Yahoo Finance下载 `^HSI` 的调整后收盘价

#### 6.2 计算HSI的年化收益与风险

$$E[R_{HSI}] = \text{mean}(\ln(P_t/P_{t-1})) \times 252$$

$$\sigma_{HSI} = \text{std}(\ln(P_t/P_{t-1})) \times \sqrt{252}$$

### 输出

- 恒生指数点：$(σ_{HSI}, E[R_{HSI}])$

---

## 第7步：绘制有效前沿与CML

### 目标
在同一张图上展示：有效前沿、CML、市场组合M、恒生指数HSI。

### 图上包括

- **蓝色曲线**：有效前沿
- **红色直线**：CML（连接 Rf 与 M）
- **绿色点**：恒生指数 (HSI)
- **蓝色点**：无风险点 (Rf)

### 并标注位置关系

- 若 HSI 在 CML 上 → 市场有效
- 若 HSI 在 CML 下方 → 市场低效

---

## 第8步：计算绩效指标

### 补充分析

#### 1. 夏普比率 (Sharpe Ratio)

$$SR = \frac{E[R_p] - R_f}{\sigma_p}$$

#### 2. 信息比率 (Information Ratio)

$$IR = \frac{E[R_{HSI}] - E[R_M]}{\sqrt{\text{Var}(R_{HSI} - R_M)}}$$

衡量 HSI 相对于市场组合 M 的超额收益。

#### 3. Jensen's Alpha

$$\alpha = E[R_{HSI}] - (R_f + \beta_{HSI}(E[R_M] - R_f))$$

#### 4. Beta 系数

$$\beta = \frac{\text{Cov}(R_{HSI}, R_M)}{\text{Var}(R_M)}$$

### 输出

- 对应夏普比率、α、β 值比较表

---

## 第9步：结果解释与论文写作

### 目标
将分析结果转化为结论和文字。

### 撰写要点

#### 1. 实证结果分析
- HSI 与 M 的相对位置；
- 港股市场效率结论；
- 投资者风险偏好讨论。

#### 2. 绩效指标表格 (Sharpe, IR, Alpha, Beta)

#### 3. 局限性与扩展建议
- 样本范围限制；
- 未考虑交易成本、外资流入；
- 未来可拓展至多因子模型。

### 输出成果

- Word论文初稿或报告PPT
- 附图表：
  - 有效前沿 + CML 图
  - 市场组合与恒生指数位置图
  - 绩效指标比较表

---

## 三、详细执行步骤（操作层面）

### 步骤 1：清洗股票数据

**文件**：消股历史行情**2019.1.1-2025.6.30**

1. 合并两个文件（2019-2022, 2023-2025）
2. 保留字段：日期、股票代码、收盘价
3. 剔除退市公司（用"退市信息"核对）
4. 确保所有股票日期对齐（同一天都有在收盘价）

**输出结果**：
一个 **价格矩阵**（日期 × 股票），如：

| Date | 00001 | 00002 | 00003 | ... |
|------|-------|-------|-------|-----|

---

### 步骤 2：计算收益率矩阵

1. **计算对数收益率**

$$r_{i,t} = \ln\frac{P_{i,t}}{P_{i,t-1}}$$

2. **删除首行**（因为没有前一日）
3. **得到收益率矩阵 R**

**输出结果**：
一个 **收益率矩阵**（T × N），用于协方差计算。

---

### 步骤 3：计算均值与协方差矩阵

```python
mu = R.mean() * 252          # 年化收益率
Sigma = R.cov() * 252        # 年化协方差矩阵
```

**得到**：

- 平均收益率向量 **μ**
- 协方差矩阵 **Σ**

---

### 步骤 4：构建有效前沿

使用优化（最小化方差、给定收益）：

$$\min_w w'\Sigma w, \quad s.t. \; w'\mu = \mu_p, \sum w = 1$$

扫描不同 $\mu_p$，得到曲线。

**输出**：

- 有效前沿曲线
- 不同组合的风险-收益坐标点

---

### 步骤 5：求切点组合（最大夏普比率）

引入无风险利率 $R_f$（用你下载的'Price'列取均值）

$$SR = \frac{E[R_p] - R_f}{\sigma_p}$$

最大化夏普比率，得到切点组合 $M$。

**输出**：

- 切点坐标：$(σ_M, E[R_M])$
- 夏普比率最大值 = CML斜率

---

### 步骤 6：计算恒生指数（HSI）的收益与风险

从恒生指数数据中计算：

$$E[R_{HSI}] = \text{mean}(\ln(P_t/P_{t-1})) \times 252$$

$$\sigma_{HSI} = \text{std}(\ln(P_t/P_{t-1})) \times \sqrt{252}$$

**输出**：

- 恒生指数点：$(σ_{HSI}, E[R_{HSI}])$

---

### 步骤 7：绘制有效前沿与CML

**图上包括**：

- **蓝色曲线**：有效前沿
- **红色直线**：CML（连接 Rf 与 M）
- **绿色点**：恒生指数 (HSI)
- **蓝色点**：无风险点 (Rf)

**并标注位置关系**：

- 若 HSI 在 CML 上 → 市场有效
- 若 HSI 在 CML 下方 → 市场低效

---

### 步骤 8：计算绩效指标

**补充分析**：

1. **夏普比率** (Sharpe Ratio)
2. **信息比率** (Information Ratio)

$$IR = \frac{E[R_{HSI}] - E[R_M]}{\sqrt{\text{Var}(R_{HSI} - R_M)}}$$

3. **Jensen's Alpha**
4. **Beta 系数**

---

### 步骤 9：结果解释与论文写作

撰写"实证结果分析"章节，包括：

- 有效前沿与CML图形（附坐标说明）
- M与HSI对比（理论与实证差距）
- 夏普比率结果（表格化）
- 市场效率结论（文字分析）

---

## 四、对应论文结构（结合你原先框架）

| 章节 | 内容要点 | 数据/结果 |
|------|----------|-----------|
| **4. 数据与方法** | 数据来源（港股、HSI、Rf）、计算方法 | 各数据集说明 |
| **5. 实证分析** | 有效前沿 + CML 构建过程 | 图与公式 |
| **6. 结果与讨论** | M、HSI、Rf 对比，市场效率判断 | 图 + 文字解释 |
| **7. 结论** | 研究结论、市场启示、局限性 | 总结观点 |

---

## 五、关键Python代码汇总

### 5.1 数据下载与清洗

```python
import yfinance as yf
import pandas as pd

# 下载股票数据
tickers = ['0700.HK', '9988.HK', '2318.HK', '0941.HK', '0011.HK', '0005.HK']
data = yf.download(tickers, start='2019-01-01', end='2024-12-31')['Adj Close']

# 计算日收益率
returns = np.log(data / data.shift(1)).dropna()

# 保存
returns.to_csv('returns.csv')
```

### 5.2 计算均值与协方差

```python
mu = returns.mean() * 252          # 年化
Sigma = returns.cov() * 252
```

### 5.3 构建有效前沿

```python
import cvxpy as cp
import numpy as np

n = len(mu)
target_returns = np.linspace(mu.min(), mu.max(), 50)
frontier_risk = []
frontier_return = []

for target in target_returns:
    w = cp.Variable(n)
    risk = cp.quad_form(w, Sigma.values)
    constraints = [cp.sum(w) == 1, mu.values @ w == target]
    prob = cp.Problem(cp.Minimize(risk), constraints)
    prob.solve()

    if prob.status == 'optimal':
        frontier_risk.append(np.sqrt(prob.value))
        frontier_return.append(target)
```

### 5.4 求切点组合（最大夏普比率）

```python
rf = 0.025  # 无风险利率 2.5%

# 目标：最大化 (E[Rp] - rf) / σp
# 等价于：最大化 (μ'w - rf) / sqrt(w'Σw)

w = cp.Variable(n)
ret = mu.values @ w
risk = cp.quad_form(w, Sigma.values)
objective = (ret - rf) / cp.sqrt(risk)

prob = cp.Problem(cp.Maximize(objective), [cp.sum(w) == 1])
prob.solve()

w_tangency = w.value
ret_m = mu.values @ w_tangency
risk_m = np.sqrt(w_tangency @ Sigma.values @ w_tangency)
sharpe_m = (ret_m - rf) / risk_m
```

### 5.5 计算HSI指标

```python
# 下载恒生指数
hsi = yf.download('^HSI', start='2019-01-01', end='2024-12-31')['Adj Close']
hsi_returns = np.log(hsi / hsi.shift(1)).dropna()

# 年化
hsi_mean = hsi_returns.mean() * 252
hsi_std = hsi_returns.std() * np.sqrt(252)
hsi_sharpe = (hsi_mean - rf) / hsi_std
```

### 5.6 绘制CML图

```python
import matplotlib.pyplot as plt

plt.figure(figsize=(10, 6))

# 有效前沿
plt.plot(frontier_risk, frontier_return, 'b-', label='Efficient Frontier', linewidth=2)

# CML
cml_x = np.linspace(0, max(frontier_risk), 100)
cml_y = rf + sharpe_m * cml_x
plt.plot(cml_x, cml_y, 'r--', label='CML', linewidth=2)

# 切点 M
plt.scatter(risk_m, ret_m, c='red', s=100, marker='o', label='Market Portfolio M')

# HSI
plt.scatter(hsi_std, hsi_mean, c='green', s=100, marker='s', label='HSI')

# 无风险点
plt.scatter(0, rf, c='blue', s=100, marker='D', label='Risk-free Rate')

plt.xlabel('Risk (σ)')
plt.ylabel('Expected Return E[R]')
plt.title('Efficient Frontier and Capital Market Line')
plt.legend()
plt.grid(True)
plt.show()
```

---

## 六、常见问题与注意事项

### Q1：如何选择股票样本？
**A**：建议使用恒生指数成分股（30-50只），代表性强且流动性好。可从恒指官网或财经网站获取最新成分股列表。

### Q2：数据缺失怎么办？
**A**：
- 少量缺失：用前向填充 (forward fill)
- 大量缺失：删除该股票或使用更短时间区间

### Q3：无风险利率如何确定？
**A**：使用香港金管局3个月期政府债券收益率，通常在2-3%范围。也可使用美国国债利率作为参考。

### Q4：为什么要年化？
**A**：因为日收益率很小，年化后便于理解和比较（×252个交易日，标准差×√252）。

### Q5：如果HSI不在有效前沿上说明什么？
**A**：说明恒指成分股的权重配置可能不是最优的，或市场存在非理性因素、制度限制等。这正是论文要讨论的核心问题。

### Q6：优化求解失败怎么办？
**A**：
- 检查协方差矩阵是否正定（可能需要正则化）
- 调整约束条件（如允许卖空或限制权重范围）
- 使用 `scipy.optimize` 替代 `cvxpy`

---

## 七、实验检查清单

在完成实验后，请确认以下内容：

- [ ] 数据已清洗，无缺失值
- [ ] 收益率计算正确（对数收益率）
- [ ] 均值向量和协方差矩阵已年化
- [ ] 有效前沿曲线光滑合理
- [ ] 找到切点组合M并计算夏普比率
- [ ] CML图包含所有关键点（Rf、M、HSI、有效前沿）
- [ ] HSI位置已标注并分析
- [ ] 绩效指标已计算（Sharpe、IR、Alpha、Beta）
- [ ] 图表清晰，带有标签和图例
- [ ] 结果已整理成论文格式

---

## 八、参考输出示例

### 预期图表

1. **有效前沿与CML图**
   - X轴：风险 (标准差)
   - Y轴：预期收益
   - 包含：蓝色曲线（有效前沿）、红色直线（CML）、绿色点（HSI）、蓝色点（Rf）、红色点（M）

2. **绩效指标对比表**

| 指标 | 市场组合 M | 恒生指数 HSI |
|------|-----------|-------------|
| 预期收益 | 12.5% | 10.8% |
| 风险 (σ) | 18.2% | 19.5% |
| 夏普比率 | 0.55 | 0.45 |
| Alpha | - | -1.2% |
| Beta | 1.0 | 1.05 |

3. **市场组合权重表**

| 股票代码 | 权重 |
|---------|------|
| 0700.HK | 15.2% |
| 9988.HK | 8.5% |
| ... | ... |

---

## 总结

本实验通过系统的步骤，从数据收集、清洗，到投资组合优化、有效前沿构建、资本市场线绘制，最后比较理论模型与实际市场表现（恒生指数），完整实现了现代投资组合理论在港股市场的实证研究。

整个流程既包含严谨的数学建模，也涉及Python编程实现，最终输出可视化图表和量化指标，为论文写作提供坚实的数据支撑。
